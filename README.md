# Воркшоп по архитектурам веб-сервисов

В данном репозитории представлен бэкенд для веб-сервиса Пользовательских Заметок.

Функционал сервиса включает в себя следующие возможности:
- Регистрация нового пользователя
- Создание заметок от имени текущего пользователя
- Получение всех заметок текущего пользователя
- Удаление заметки текущего пользователя по Id

## Архитектура

Сервис использует Анемичную Модель, т.е. бизнес-логика вынесена из сущностей в отдельные объекты сервисы, которые инкапсулируют все бизнес-правила и инварианты.

Сервис построен на основе Гексагональной Архитектуры, в центре которой Core - ядро приложения с бизнес-логикой. 

Слой Presentation является слоем с первичными адаптерами (в терминах гексогональной архитектуры) и роль первичных адаптеров исполняют контроллеры. Контроллеры принимают входящие запросы и вызывают соответствующие методы ядра. Слой Presentation построен с использованием паттерна MVC.

DataAccess - это слой вторичных адаптеров для доступа к данным. Вторичные адаптеры реализуют интерфейсы, от которых зависит ядро.

## Presentation слой

Представляет собой веб-сервис и построен на основе фреймворка ASP.NET Core с использованием паттерна MVC. Добавлена поддержка Swagger для автоматический генерации удобного фронтенда для завимодейтсвия с методами сервиса.

Для аутентификации используется Basic Auth из сторонней библиотеки AspNetCore.Authentication.Basic.

Т.к. этот слой содержит метод `Main` и явялется точкой входа в приложение, то он так же отвечает за сборку DI-контейнера из-за чего у него есть зависимость от DataAccess слоя. Технически это нарушение зависмостей и оно может привести к прямым вызовам из Presentation в DataAccess, что является ошибкой.

## Core слой

Содержит бизнес-логику, которая в этом проекте очень простая. Предоставляет экстеншн-метод AddCore() для простой регистрации всего слоя в DI-контейнере. 

Имеет два интерфейса `INotesStorage` и `IUserStorage`, которые должны быть реализованы в DataAccess слое. В идеале эти интерфейсы можно заменить полноценный паттерн [Repository](https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design).

## DataAccess слой

Представлен в виде двух реализаций: с полноценной БД и InMemory.

### DataAccess.Postgres

Реализует `INotesStorage` и `IUserStorage` путем явных SQL запросов в БД. Для наглядности и простоты здесь не используется никаких ORM.

Слой использует следующие библиотеки:
- [Npgsql](https://www.npgsql.org/) - для подключения к PostgreSQL
- [Dapper](https://www.learndapper.com/) - для маппинга сырых табличных данных на объекты приложения
- [dbup-postgresql](https://dbup.readthedocs.io/en/latest/) - для создания и миграции схемы БД. Скрипты миграции лежат в `SqlScripts`

Настройки для подключения к БД лежат в Presentation, т.к. он хостит процесс, в файле `appsettings.Development.json`.

### DataAccess.InMemory

Простая InMemory реализация интерфейсов `INotesStorage` и `IUserStorage`.

## Запуск приложения

Т.к. данный сервис зависит от БД, то самый простой удобный вариант это поднимать PostgreSQL, pgAdmin и наш сервис в общем docker-compose. Для этого в солюшене создан проект `docker-compose`, который нужно выбрать как Startup Project. Он поднимет сервис и всего его зависимости так как это описано в `docker-compose.yml`

После запуска будет доступен Swagger UI по адресу http://localhost:8080/swagger. 

По адресу http://localhost:8081/browser/ будет доступна web версия pgAdmin, в котором нужно зарегистрировать сервер БД:
- Host - postgres
- Port - 5432
- Maintenance DB - postgres
- Username - postgres
- Password - postgres